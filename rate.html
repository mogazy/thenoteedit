<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة إدارة التقييمات</title>
    <!-- تضمين Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container-bg {
            background-color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1-px rgba(0, 0, 0, 0.06);
        }
        .modal-bg {
            background-color: rgba(0, 0, 0, 0.5);
        }
        .approved-status {
            background-color: #d1fae5; /* green-100 */
            color: #065f46; /* green-800 */
        }
        .not-approved-status {
            background-color: #fee2e2; /* red-100 */
            color: #991b1b; /* red-800 */
        }
    </style>
</head>
<body class="flex flex-col min-h-screen text-right">

    <!-- Header -->
    <header class="p-4 bg-purple-900 text-white rounded-b-xl shadow-md">
        <div class="flex justify-between items-center w-full h-full">
            <span class="text-2xl font-bold">لوحة الإدارة</span>
            <a href="#" class="inline-block px-4 py-2 text-white bg-purple-500 rounded-lg shadow-md hover:bg-purple-600 transition duration-300">
                العودة للصفحة الرئيسية
            </a>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow p-4 md:p-6">
        <div class="max-w-4xl mx-auto p-4 md:p-8 rounded-xl container-bg">
            <h1 class="text-3xl font-extrabold mb-8 text-center text-gray-800">إدارة التقييمات</h1>

            <!-- Loading Spinner -->
            <div id="loadingSpinner" class="flex justify-center items-center h-48">
                <svg class="animate-spin h-10 w-10 text-purple-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>

            <!-- List of Reviews -->
            <div id="reviewsList" class="hidden space-y-4">
                <p id="noReviewsMessage" class="text-center text-gray-500">لا توجد تقييمات لإدارتها.</p>
            </div>
        </div>
    </main>

    <!-- Edit Modal -->
    <div id="editModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-bg">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md mx-4">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">تعديل التقييم</h2>
            <form id="editForm" class="space-y-4">
                <input type="hidden" id="editReviewId">
                <div>
                    <label for="editUserName" class="block text-lg font-medium text-gray-700">اسمك:</label>
                    <input type="text" id="editUserName" class="mt-1 block w-full rounded-md border-gray-500 shadow-sm focus:border-purple-500 focus:ring-purple-500 p-2">
                </div>
                <div>
                    <label for="editRating" class="block text-lg font-medium text-gray-700">التقييم:</label>
                    <input type="number" id="editRating" min="1" max="10" class="mt-1 block w-full rounded-md border-gray-500 shadow-sm focus:border-purple-500 focus:ring-purple-500 p-2">
                </div>
                <div>
                    <label for="editComment" class="block text-lg font-medium text-gray-700">التعليق:</label>
                    <textarea id="editComment" rows="4" class="mt-1 block w-full rounded-md border-gray-500 shadow-sm focus:border-purple-500 focus:ring-purple-500 p-2"></textarea>
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" id="cancelEditButton" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">إلغاء</button>
                    <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">حفظ التغييرات</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Modal -->
    <div id="deleteModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-bg">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm mx-4 text-center">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">تأكيد الحذف</h2>
            <p class="mb-6 text-gray-700">هل أنت متأكد أنك تريد حذف هذا التقييم؟ لا يمكن التراجع عن هذا الإجراء.</p>
            <div class="flex justify-center space-x-4">
                <button id="cancelDeleteButton" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">إلغاء</button>
                <button id="confirmDeleteButton" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">حذف</button>
            </div>
        </div>
    </div>

    <!-- تضمين مكتبات Firebase اللازمة -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // تهيئة مشروع Firebase الخاص بك
        const firebaseConfig = {
            apiKey: "AIzaSyCWxQCNU-91cK2FwiL3zs1_bKO6LtJHTz4",
            authDomain: "rate-f04e2.firebaseapp.com",
            projectId: "rate-f04e2",
            storageBucket: "rate-f04e2.firebase-app.com",
            messagingSenderId: "236207388801",
            appId: "1:236207388801:web:2274a016a6d2a5dee8f580",
            measurementId: "G-WM812E8GPQ"
        };

        // تهيئة Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // UI Elements
        const loadingSpinner = document.getElementById('loadingSpinner');
        const reviewsListDiv = document.getElementById('reviewsList');
        const noReviewsMessage = document.getElementById('noReviewsMessage');
        const editModal = document.getElementById('editModal');
        const editForm = document.getElementById('editForm');
        const editReviewIdInput = document.getElementById('editReviewId');
        const editUserNameInput = document.getElementById('editUserName');
        const editRatingInput = document.getElementById('editRating');
        const editCommentInput = document.getElementById('editComment');
        const cancelEditButton = document.getElementById('cancelEditButton');
        const deleteModal = document.getElementById('deleteModal');
        const confirmDeleteButton = document.getElementById('confirmDeleteButton');
        const cancelDeleteButton = document.getElementById('cancelDeleteButton');

        let reviewToDeleteId = null;

        // مرجع لمجموعة 'reviews' في Firestore
        const reviewsCollectionRef = collection(db, 'reviews');

        // Function to render all reviews
        function renderReviews(reviews) {
            reviewsListDiv.innerHTML = ''; // Clear previous content
            
            if (reviews.length === 0) {
                noReviewsMessage.classList.remove('hidden');
                reviewsListDiv.appendChild(noReviewsMessage);
            } else {
                noReviewsMessage.classList.add('hidden');
                reviews.forEach(review => {
                    const reviewElement = document.createElement('div');
                    reviewElement.className = 'flex flex-col md:flex-row items-start md:items-center p-4 rounded-lg shadow-md bg-white border border-gray-200';
                    reviewElement.innerHTML = `
                        <div class="flex-grow mb-4 md:mb-0">
                            <div class="flex items-center mb-2">
                                <span class="font-bold text-lg text-gray-800">${review.name}</span>
                                <span class="mr-4 text-xl font-bold text-purple-600">${review.rating} / 10</span>
                            </div>
                            <p class="text-gray-700">${review.comment}</p>
                        </div>
                        <div class="flex-shrink-0 flex space-x-2 space-x-reverse">
                            <button data-id="${review.id}" data-approved="${review.approved}" class="toggle-approved-btn px-4 py-2 rounded-lg text-sm font-semibold transition duration-200 ${review.approved ? 'approved-status' : 'not-approved-status'}">
                                ${review.approved ? 'إخفاء' : 'إظهار'}
                            </button>
                            <button data-id="${review.id}" data-name="${review.name}" data-rating="${review.rating}" data-comment="${review.comment}" class="edit-btn px-4 py-2 bg-blue-500 text-white rounded-lg text-sm font-semibold hover:bg-blue-600 transition duration-200">
                                تعديل
                            </button>
                            <button data-id="${review.id}" class="delete-btn px-4 py-2 bg-red-500 text-white rounded-lg text-sm font-semibold hover:bg-red-600 transition duration-200">
                                حذف
                            </button>
                        </div>
                    `;
                    reviewsListDiv.appendChild(reviewElement);
                });
            }

            // Add event listeners to the new buttons
            document.querySelectorAll('.toggle-approved-btn').forEach(button => {
                button.addEventListener('click', toggleApproved);
            });
            document.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', showEditModal);
            });
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', showDeleteModal);
            });
        }
        
        // Function to toggle the approved status
        async function toggleApproved(e) {
            const reviewId = e.target.dataset.id;
            const currentStatus = e.target.dataset.approved === 'true';
            
            try {
                const reviewRef = doc(db, 'reviews', reviewId);
                await updateDoc(reviewRef, { approved: !currentStatus });
            } catch (error) {
                console.error("خطأ في تحديث حالة التقييم:", error);
            }
        }
        
        // Function to show the edit modal
        function showEditModal(e) {
            const button = e.target;
            const reviewId = button.dataset.id;
            const name = button.dataset.name;
            const rating = button.dataset.rating;
            const comment = button.dataset.comment;
            
            editReviewIdInput.value = reviewId;
            editUserNameInput.value = name;
            editRatingInput.value = parseInt(rating, 10);
            editCommentInput.value = comment;
            
            editModal.classList.remove('hidden');
        }
        
        // Function to handle edit form submission
        editForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const reviewId = editReviewIdInput.value;
            const newName = editUserNameInput.value.trim();
            const newRating = parseInt(editRatingInput.value, 10);
            const newComment = editCommentInput.value.trim();
            
            if (!newName || isNaN(newRating) || newRating < 1 || newRating > 10) {
                // In a real app, you would show an error message
                console.error("بيانات غير صالحة للتعديل.");
                return;
            }
            
            try {
                const reviewRef = doc(db, 'reviews', reviewId);
                await updateDoc(reviewRef, {
                    name: newName,
                    rating: newRating,
                    comment: newComment
                });
                editModal.classList.add('hidden');
            } catch (error) {
                console.error("خطأ في تحديث التقييم:", error);
            }
        });

        // Function to show the delete modal
        function showDeleteModal(e) {
            reviewToDeleteId = e.target.dataset.id;
            deleteModal.classList.remove('hidden');
        }
        
        // Function to handle delete confirmation
        async function deleteReview() {
            if (reviewToDeleteId) {
                try {
                    await deleteDoc(doc(db, 'reviews', reviewToDeleteId));
                    deleteModal.classList.add('hidden');
                } catch (error) {
                    console.error("خطأ في حذف التقييم:", error);
                }
            }
        }
        
        // Event listeners for modals
        cancelEditButton.addEventListener('click', () => editModal.classList.add('hidden'));
        cancelDeleteButton.addEventListener('click', () => deleteModal.classList.add('hidden'));
        confirmDeleteButton.addEventListener('click', deleteReview);

        // Main initialization function
        async function initApp() {
            // الاستماع إلى جميع التغييرات في مجموعة 'reviews'
            onSnapshot(reviewsCollectionRef, (snapshot) => {
                const reviews = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderReviews(reviews);
                loadingSpinner.classList.add('hidden');
                reviewsListDiv.classList.remove('hidden');
            }, (error) => {
                console.error("خطأ في جلب البيانات:", error);
                loadingSpinner.classList.add('hidden');
                reviewsListDiv.classList.remove('hidden');
                reviewsListDiv.textContent = 'حدث خطأ في جلب البيانات. يرجى إعادة تحميل الصفحة.';
            });
        }
        
        window.addEventListener('load', initApp);
    </script>
</body>
</html>
